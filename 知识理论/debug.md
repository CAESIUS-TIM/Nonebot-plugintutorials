# 写插件时候的一些技巧

> *Wait for perfection*

#### 善用搜索引擎

这其实是每个程序员都应该掌握的本领。当有什么需要使用的知识点遗忘了或者程序报了自己不会处理的错误的时候，善于使用百度，Google等搜索引擎搜索错误原因，去CSDN或者stackoverflow寻求解决方案，参考别人的意见。不要怕改了程序继续出错，只怕你不去试。

##### 我该搜什么?

有些人可能会问：那要搜索什么呢？用一句话概括就是要去搜索"**关键性报错**"。比如看下面这段报错

```shell
Traceback (most recent call last):
  File "E:\Code\Python\1.py", line 1, in <module>
    raise Exception("new ex")
Exception: new ex
```

> 这是故意抛出的一个报错。

可以简单的把这段报错分为两个部分：上面的`Traceback`到`raise Exception("new ex")`，和下面的`Exception: new ex`。第一部分指明报错发生的具体位置。一般情况下这部分会有很多行的错误定位，而最下面的那个错误定位<u>一般</u>是用户自己编写的py文件当中抛出错误的地方，越往上越底层(即追入第三方库和python源码当中)，类似于调试时一直点**"强制步入"**一样。因此**<u>一般情况下(若是异步函数等情况会比较复杂)</u>**只需要看最底下那个定位就能追到自己源码当中具体哪个位置抛出的错误。

第二部分是发生的**具体报错原因**，这里通常是诊断问题的关键部分，很多小白问问题的时候截图报错信息只截到了上半部分(一堆路径)，这部分完全没截到(有用的报错您是一点都没截到.jpg, 我们学的是程序不是算命)，导致没有办法解决错误。而这里也是可以直接复制然后放到搜索引擎搜索的部分。

#### 善用print/log语句

Nonebot2的插件是需要启动Nonebot服务并接入消息收发端后才能正常运行，所以调试起来非常麻烦，虽然有Nonebug插件，但是其有一定的使用门槛。如果你不知道某个变量的内容到底是什么，最简单直接的办法是使用`print`打印出其内容。比如在[requestapp](https://github.com/MRSlouzk/Nonebot-plugintutorials/blob/main/%E5%85%B7%E4%BD%93%E6%A1%88%E4%BE%8B/requestapp.md)中讲到的群申请事件的`event.json`，你如果想知道它里面包含的内容和文本结构，将它打印出来或者写入本地文件都是好办法。当然，打印输出也可以使用`logger`模块，会更加规范化，具体用哪个就看个人喜好了。

##### nonebot.log包的使用(未完成)

***注意：log包用于输出日志，其本质和`print`类似，不过会更好看一点，要不要用根据自己的需求来决定***

TODO

------

另外gocq和nonebot2是两个独立模块，可以说两者运行互不干扰。因此调试nonebot2的同时不需要重启gocq服务，因为频繁重启gocq更易导致bot被风控(在调试nonebot插件时请不要使用[NoneBot的go-cqhttp启动器](https://github.com/mnixry/nonebot-plugin-gocqhttp)插件，因为此插件会随着nonebot平台的重启而重启gocq服务)。

#### 遇到解决不了的问题时可以适当参考他人插件

很多时候有些程序处理思路是我们无法轻易想到的，这时候可以查看其它开源插件的源码(商店是个好地方)，以此得到灵感。**但是不要只是单纯的CV源码**，这样缺乏自己思考的过程，下次遇到这种问题还需要去CV。

#### 做好权限管理

一些可以操作到机器人后台数据的指令尽量都要加上`permission`参数。为什么不用`rule`？因为rule只在响应器被触发的时候生效，后续的如`got`修饰器都不会生效，而`permission`适用于整个响应器执行过程，适用之后的多步响应器操作。

- [ ] 自定义规则rule类(待写)

#### 抽取共同函数/变量组成`utils`依赖包，方便统一管理。

插件较少时要管理的话较为容易，但是插件越来越多，体量越来越大的时候，一些诸如日志输出、文件路径、适配器参数，数据库连接等功能代码会出现大量重复，较难调控。改一部分其它全都要去修改，非常麻烦。这时候就需要写一个统一的`utils`文件来管理了，要养成规范进行代码编写的好习惯。

#### 待续......